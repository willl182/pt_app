---
title: "Informe Final del Ensayo de Aptitud (EA)"
subtitle: "Medición de Gases Contaminantes Criterio SO₂, CO, O₃, NO, NO₂"
author: "Laboratorio CALAIRE"
date: "`r Sys.Date()`"
output:
  word_document:
    toc: true
    toc_depth: 3
    reference_docx: null
params:
  hom_data: NA
  stab_data: NA
  summary_data: NA
  metric: "z"
  method: "3"
  pollutant: NULL
  level: "level_1"
  n_lab: 7
  k_factor: 2
  # Identification params
  scheme_id: "EA-202X-XX"
  report_id: "INF-202X-XX"
  issue_date: NA
  period: "Mes - Mes Año"
  coordinator: "Nombre"
  quality_pro: "Nombre"
  ops_eng: "Nombre"
  quality_manager: "Nombre"
  # Data summaries
  participants_data: NA
  grubbs_summary: NA
  xpt_summary: NA
  homogeneity_summary: NA
  stability_summary: NA
  score_summary: NA
  heatmaps: NA
  participant_data: NA
  metrological_compatibility: NA
  metrological_compatibility_method: "2a"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 5)
library(tidyverse)
library(knitr)
library(kableExtra)
library(outliers)

# Helper: nIQR
calculate_niqr <- function(x) {
  x_clean <- x[is.finite(x)]
  if (length(x_clean) < 2) return(NA_real_)
  quartiles <- stats::quantile(x_clean, probs = c(0.25, 0.75), na.rm = TRUE, type = 7)
  0.7413 * (quartiles[2] - quartiles[1])
}

# Helper: Prepare Wide Data
get_wide_data <- function(df, target_pollutant) {
  filtered <- df %>% filter(pollutant == target_pollutant)
  if (nrow(filtered) == 0) return(NULL)
  filtered %>%
    select(-pollutant) %>%
    pivot_wider(names_from = replicate, values_from = value, names_prefix = "sample_")
}

# Lógica: Algoritmo A (ISO 13528)
run_algorithm_a <- function(values, max_iter = 50) {
  values <- values[is.finite(values)]
  n <- length(values)
  if (n < 3) return(list(mean = NA, sd = NA, error = "N<3"))
  
  x_star <- median(values, na.rm = TRUE)
  s_star <- 1.483 * median(abs(values - x_star), na.rm = TRUE)
  
  # Handle zero s_star
  if (s_star < 1e-9) s_star <- sd(values, na.rm = TRUE)
  if (s_star < 1e-9) return(list(mean = x_star, sd = 0, error = "Zero dispersion"))

  for (i in 1:max_iter) {
    u_val <- (values - x_star) / (1.5 * s_star)
    w <- ifelse(abs(u_val) <= 1, 1, 1/u_val^2)
    
    sum_w <- sum(w)
    if (sum_w == 0) break
    
    x_new <- sum(w * values) / sum_w
    
    # Avoid negative in sqrt
    var_w <- sum(w * (values - x_new)^2) / sum_w
    if (var_w < 0) var_w <- 0
    s_new <- sqrt(var_w)
    
    if (abs(x_new - x_star) < 1e-4 && abs(s_new - s_star) < 1e-4) break
    x_star <- x_new
    s_star <- s_new
  }
  list(mean = x_star, sd = s_star, error = NULL)
}

# Lógica: Cálculo de Homogeneidad
compute_homogeneity <- function(data_full, pol, lev) {
  wide <- get_wide_data(data_full, pol) %>% filter(level == lev)
  if(nrow(wide) == 0) return(NULL)
  
  cols_sample <- grep("sample_", names(wide), value = TRUE)
  m <- length(cols_sample)
  g <- nrow(wide)
  
  long_data <- wide %>%
    mutate(Item = row_number()) %>%
    pivot_longer(cols = all_of(cols_sample), values_to = "Result")
  
  item_stats <- long_data %>%
    group_by(Item) %>%
    summarise(mean = mean(Result, na.rm = TRUE), diff = max(Result, na.rm = TRUE) - min(Result, na.rm = TRUE), .groups = "drop")
  
  general_mean <- mean(item_stats$mean, na.rm = TRUE)
  s_x_bar_sq <- var(item_stats$mean, na.rm = TRUE)
  
  sw <- sqrt(sum(item_stats$diff^2) / (2 * g))
  ss <- sqrt(max(0, s_x_bar_sq - (sw^2 / m)))
  
  sample1 <- wide$sample_1
  sigma_pt <- 1.483 * median(abs(sample1 - median(sample1, na.rm = TRUE)), na.rm = TRUE)
  c_crit <- 0.3 * sigma_pt
  
  list(
    ss = ss, sw = sw, sigma_pt = sigma_pt, c_crit = c_crit, 
    mean = general_mean, passed = ss <= c_crit
  )
}
```

## 1.1. Información del Proveedor y del esquema

**Alcance:** Este Ensayo de Aptitud (EA) por comparación interlaboratorio abarca la medición de los gases contaminantes criterio SO₂, CO, O₃, NO y NO₂ en aire cero, según lo definido en el `r params$scheme_id`.

**Objetivo Principal:** Evaluar el desempeño de los laboratorios participantes en la medición de los gases contaminantes criterio, conforme a los requisitos de la norma ISO/IEC 17043:2023 y utilizando los métodos estadísticos de la norma ISO 13528:2022.

## 1.3. Confidencialidad y Uso del Informe

La identidad de los participantes es confidencial y solo conocida por el personal autorizado de CALAIRE involucrado en la operación del esquema de EA. Se utilizan códigos de laboratorio anonimizados en este informe para asegurar la confidencialidad, según lo estipulado en la política de confidencialidad del laboratorio. Este informe es para uso de los participantes y, cuando aplique, de sus organismos de acreditación o autoridades regulatorias. Cualquier otro uso debe ser autorizado por CALAIRE.

## 1.4. Roles de Autorización y Personal Clave

La organización, ejecución y evaluación de este EA se realizó bajo la responsabilidad del Laboratorio CALAIRE. Los roles clave involucrados fueron:

**Coordinador EA:** `r params$coordinator`  
**Profesional Calidad Aire:** `r params$quality_pro`  
**Ingeniero Operativo:** `r params$ops_eng`  
**Profesional de Gestión de Calidad:** `r params$quality_manager`

## 1.5. Participantes e Instrumentación

En esta ronda del EA participaron `r length(unique(params$summary_data$participant_id)) - 1` laboratorios. A continuación, se lista a los participantes (mediante código asignado).

```{r participants_table, echo=FALSE}
# Use uploaded participants data if available, otherwise use placeholders
if (!is.null(params$participants_data) && is.data.frame(params$participants_data)) {
  # Use uploaded data
  final_part_df <- params$participants_data
} else {
  # Create default table with placeholders
  participants <- unique(params$summary_data$participant_id)
  participants <- participants[participants != "ref"]
  
  part_df <- data.frame(
    Codigo_Lab = participants,
    Analizador_SO2 = "[Info Participante]",
    Analizador_CO = "[Info Participante]",
    Analizador_O3 = "[Info Participante]",
    Analizador_NO_NO2 = "[Info Participante]",
    stringsAsFactors = FALSE
  )
  
  # Add Reference row at the top
  ref_row <- data.frame(
    Codigo_Lab = "REFERENCIA",
    Analizador_SO2 = "HORIBA APSA- 370",
    Analizador_CO = "Teledyne T300",
    Analizador_O3 = "Thermo 49i",
    Analizador_NO_NO2 = "HORIBA APSA- 370",
    stringsAsFactors = FALSE
  )
  
  final_part_df <- rbind(ref_row, part_df)
}

# Ensure proper column names for display
names(final_part_df) <- c("Código Lab", "Analizador SO₂ (Marca/Modelo)", "Analizador CO (Marca/Modelo)", "Analizador O₃ (Marca/Modelo)", "Analizador NO/NO₂ (Marca/Modelo)")

kable(final_part_df, caption = "Tabla 2. Participantes del Ensayo de Aptitud")
```

# 2. Descripción del Ensayo y Metodología

## 2.1. Ítems de Ensayo y Producción

**Descripción:** Los ítems de ensayo consistieron en atmósferas de gas SO₂, CO, O₃, NO, NO₂ en aire cero, generadas dinámicamente y suministradas a los participantes a través de un colector de distribución (manifold) de vidrio inerte.

**Método de Producción:**

*   **O₃:** El O₃ es generado dinámicamente mediante un generador de ozono, trazable con un fotómetro nivel 2 en la cadena de trazabilidad de ozono.
*   **SO₂, CO, NO, NO₂:** Generados por dilución dinámica de Materiales Certificados de Referencia (MCR) trazables, utilizando controladores de flujo másico calibrados.

**Niveles de Concentración:** Se generaron 5 niveles de concentración nominal más un nivel cero para cada contaminante. La secuencia y duración de cada nivel (corrida/run) se detallan a continuación:

```{r levels_table, echo=FALSE}
# Generate Table 3 dynamically from summary_data
# We assume 'ref' values represent the target concentration for each level

if (!is.null(params$summary_data)) {
  levels_data <- params$summary_data %>%
    filter(participant_id == "ref", n_lab == params$n_lab) %>%
    select(level, pollutant, mean_value) %>%
    pivot_wider(names_from = pollutant, values_from = mean_value) %>%
    arrange(level)
  
  # Rename columns for display
  colnames(levels_data)[1] <- "Corrida"
  
  kable(levels_data, digits = 2, caption = "Tabla 3. Niveles de concentración del ítem de ensayo (Valores de Referencia)")
} else {
  cat("No hay datos de resumen disponibles para generar la Tabla 3.")
}
```

\*Los valores de concentración obedecen a los intervalos de medición establecidos en la normativa vigente y lo estipulado en los métodos US-EPA.

**Instrucciones a Participantes:** Se solicitó a los participantes reportar [3] mediciones promedio de [1 h] para cada nivel de concentración a partir de los niveles de concentración minutales.

## 2.2. Homogeneidad y Estabilidad de los Ítems de EA

Dado que los ítems de ensayo se generan dinámicamente y se miden in situ, la evaluación de homogeneidad y estabilidad se enfoca en el sistema de generación y distribución.

**Homogeneidad:** Se verificó la homogeneidad del gas distribuido a través del manifold antes del inicio del EA, midiendo la concentración en diferentes puntos de salida según ISO 13528:2022, Anexo B. Los datos de homogeneidad se presentan en el Anexo B.

**Estabilidad:** Se monitoreó la estabilidad de la concentración generada durante cada corrida mediante los instrumentos de referencia de CALAIRE, según ISO 13528:2022, Anexo B. Los datos de estabilidad se presentan en el Anexo B.

## 2.3. Determinación del Valor Asignado (Xp)

```{r assigned_value_text, echo=FALSE, results='asis'}
if (!is.null(params$method) && as.character(params$method) == "1") {
  cat("El valor asignado corresponde al valor determinado por el laboratorio de referencia: $x_{pt} = x_{ref}$.\n\n")
  cat("La desviación estándar para la evaluación de la aptitud ($\\sigma_{pt}$) corresponde a la desviación estándar reportada por el laboratorio de referencia.")
} else if (as.character(params$method) == "2a") {
  cat("El valor asignado se determinó por consenso de los participantes, utilizando un estimador robusto (mediana y MADe).\n\n")
  cat("La desviación estándar para la evaluación de la aptitud ($\\sigma_{pt}$) se estableció para cada contaminante basándose en ISO 13528:2022.\n\n")
  cat("**Método Específico:** *Por consenso:* $\\sigma_{pt} = MADe$.")
} else if (as.character(params$method) == "2b") {
  cat("El valor asignado se determinó por consenso de los participantes, utilizando un estimador robusto (mediana y nIQR).\n\n")
  cat("La desviación estándar para la evaluación de la aptitud ($\\sigma_{pt}$) se estableció para cada contaminante basándose en ISO 13528:2022.\n\n")
  cat("**Método Específico:** *Por consenso:* $\\sigma_{pt} = nIQR$.")
} else if (as.character(params$method) == "3") {
  cat("El valor asignado se determinó por consenso de los participantes, utilizando un estimador robusto (Algoritmo A).\n\n")
  cat("La desviación estándar para la evaluación de la aptitud ($\\sigma_{pt}$) se estableció para cada contaminante basándose en ISO 13528:2022.\n\n")
  cat("**Método Específico:** *Por consenso:* $\\sigma_{pt} = s^*$, donde $s^*$ es la desviación estándar robusta calculada mediante el Algoritmo A.")
} else {
  cat("El valor asignado se determinó por consenso de los participantes, utilizando un estimador robusto.\n\n")
  cat("La desviación estándar para la evaluación de la aptitud ($\\sigma_{pt}$) se estableció para cada contaminante basándose en ISO 13528:2022.")
}
```

Los valores de $\sigma_{pt}$ calculados para cada nivel se presentan en el Anexo A.

## 2.4. Compatibilidad Metrológica

Se evaluó la compatibilidad metrológica calculando las diferencias entre el valor de referencia ($x_{pt,ref}$) y los valores de consenso ($x_{pt,2a}$, $x_{pt,2b}$ y $x_{pt,3}$) para cada contaminante y nivel.

```{r metrological_compatibility_table, echo=FALSE}
if (!is.null(params$metrological_compatibility) && is.data.frame(params$metrological_compatibility) && nrow(params$metrological_compatibility) > 0) {
  
  mc_df <- params$metrological_compatibility
  method <- params$metrological_compatibility_method
  
  # Filter columns based on selected method
  if (method == "2a") {
    mc_df <- mc_df %>% select(pollutant, n_lab, level, x_pt_ref, x_pt_2a, Diff_Ref_2a)
    colnames(mc_df) <- c("Contaminante", "N_Lab", "Nivel", "Valor Ref", "Valor Consenso 2a", "Dif (Ref - 2a)")
  } else if (method == "2b") {
    mc_df <- mc_df %>% select(pollutant, n_lab, level, x_pt_ref, x_pt_2b, Diff_Ref_2b)
    colnames(mc_df) <- c("Contaminante", "N_Lab", "Nivel", "Valor Ref", "Valor Consenso 2b", "Dif (Ref - 2b)")
  } else if (method == "3") {
    mc_df <- mc_df %>% select(pollutant, n_lab, level, x_pt_ref, x_pt_3, Diff_Ref_3)
    colnames(mc_df) <- c("Contaminante", "N_Lab", "Nivel", "Valor Ref", "Valor Consenso 3 (Alg A)", "Dif (Ref - 3)")
  } else {
    # Fallback: Show all
    colnames(mc_df) <- c("Contaminante", "N_Lab", "Nivel", "Valor Ref", "Valor Consenso 2a", "Valor Consenso 2b", "Valor Consenso 3 (Alg A)", "Dif (Ref - 2a)", "Dif (Ref - 2b)", "Dif (Ref - 3)")
  }
  
  kable(mc_df, digits = 4, caption = "Tabla. Compatibilidad Metrológica: Diferencias entre Valor de Referencia y Consenso")
} else {
  cat("No hay datos de compatibilidad metrológica disponibles.")
}
```

# 3. Criterios de Evaluación

## 3.1. Desviación Estándar para la Evaluación de la Aptitud

La desviación estándar para la evaluación de la aptitud ($\sigma_{pt}$) se utilizó para el cálculo de los indicadores de desempeño z, z' y zeta.

## 3.2. Indicadores de Desempeño y criterios de evaluación

Se calcularon los siguientes indicadores de desempeño para cada resultado reportado $x_i$ por cada participante:

| Indicador | Evaluación |
| :---- | :---- |
| **Puntuación z/z’/zeta:** | |z| ≤ 2.0: **Satisfactorio**<br>2.0 < |z| < 3.0: **Cuestionable (Señal de Advertencia)**<br>|z| ≥ 3.0: **Insatisfactorio (Señal de Acción)** |
| **Puntuación En:** | |E_n| ≤ 1.0: **Satisfactorio**<br>|E_n| > 1.0: **Insatisfactorio** |

## 3.3. Tratamiento Estadístico de Datos

**Recepción y Validación:** Los resultados reportados por los participantes fueron recibidos a través del Aplicativo Web/Formulario y validados para verificar formato, unidades y completitud.

**Identificación de atípicos:** Se realizó una revisión de los datos para identificar posibles errores y atípicos, según ISO 13528:2022, 6.3.
Para ello se llevó a cabo la prueba de Grubbs para atípicos, encontrando los siguientes resultados:

```{r grubbs_table, echo=FALSE}
if (!is.null(params$grubbs_summary) && is.data.frame(params$grubbs_summary) && nrow(params$grubbs_summary) > 0) {
  
  grubbs_df <- params$grubbs_summary
  
  # Ensure proper column names for display
  colnames(grubbs_df) <- c("Contaminante", "Nivel", "Participantes Evaluados", "Valor p", "Atípicos detectados", "Participante", "Valor Atípico")
  
  kable(grubbs_df, caption = "Tabla 4. Resultados de la prueba de Grubbs para atípicos")
} else {
  cat("No se encontraron atípicos o no hay datos suficientes para la prueba de Grubbs.")
}
```

# 4. Resultados y Discusión

## 4.1. Resumen General del Desempeño

En esta ronda del EA, participaron `r params$n_lab` laboratorios.

```{r score_summary_table, echo=FALSE}
if (!is.null(params$score_summary) && is.data.frame(params$score_summary)) {
  kable(params$score_summary, caption = "Tabla 5. Resumen de desempeño por indicador")
} else {
  cat("No hay datos de resumen de desempeño disponibles.")
}
```

## 4.2. Evaluación por Contaminante

A continuación, se presenta un resumen del desempeño para cada contaminante.

```{r heatmaps_loop, echo=FALSE, results='asis', fig.height=4, fig.width=8}
if (!is.null(params$heatmaps) && length(params$heatmaps) > 0) {
  for (pol in names(params$heatmaps)) {
    cat("\n\n### Resultados para", toupper(pol), "\n\n")
    
    # Print Heatmap
    print(params$heatmaps[[pol]])
    cat("\n\n")
    
    cat("Figura. Mapa de Calor para las puntuaciones para", toupper(pol), "por participante.\n\n")
  }
} else {
  cat("No hay mapas de calor disponibles.")
}
```

# 5. Conclusiones

**Conformidad General:** El desempeño general de los laboratorios participantes en esta ronda fue positivo.

**Áreas de Preocupación:** Se observaron desempeños cuestionables o insatisfactorios en algunos participantes.

**Acciones Sugeridas para Participantes:**
Se recomienda a los laboratorios con resultados **Cuestionables** ($2.0 < |z| < 3.0$) investigar las posibles causas de la desviación.
Se requiere a los laboratorios con resultados **Insatisfactorios** ($|z| \ge 3.0$) realizar una investigación exhaustiva de las causas raíz (e.g., calibración, procedimiento, equipo) e implementar acciones correctivas documentadas.

---

# Anexo A: Valores Asignados y Desviación Estándar para Evaluación de Aptitud

A continuación se presenta el resumen de los valores asignados ($x_{pt}$), incertidumbres ($u(x_{pt})$) y desviaciones estándar para la evaluación de la aptitud ($\sigma_{pt}$) para cada contaminante y nivel, calculados según el método seleccionado.

```{r annex_a_table, echo=FALSE}
if (!is.null(params$xpt_summary) && is.data.frame(params$xpt_summary) && nrow(params$xpt_summary) > 0) {
  
  xpt_df <- params$xpt_summary
  
  # Ensure proper column names for display
  colnames(xpt_df) <- c("Contaminante", "Nivel", "Método", "Valor Asignado (x_pt)", "Incertidumbre u(x_pt)", "Desviación (sigma_pt)")
  
  kable(xpt_df, digits = 4, caption = "Tabla A.1. Resumen de Valores Asignados y Parámetros Estadísticos")
} else {
  cat("No hay datos de resumen de valores asignados disponibles.")
}
```

# Anexo B: Resumen de Homogeneidad y Estabilidad

## B.1. Resumen de Homogeneidad

```{r homogeneity_summary_table, echo=FALSE}
if (!is.null(params$homogeneity_summary) && is.data.frame(params$homogeneity_summary) && nrow(params$homogeneity_summary) > 0) {
  
  hom_df <- params$homogeneity_summary
  
  # Proper column names for display
  colnames(hom_df) <- c("Contaminante", "Nivel", "Items", "Réplicas", "sigma_pt", "u(x_pt)", "ss", "sw", "Criterio c", "Cumple", "Conclusión")
  
  kable(hom_df, digits = 4, caption = "Tabla B.1. Resumen de Evaluación de Homogeneidad")
} else {
  cat("No hay datos de homogeneidad disponibles.")
}
```

## B.2. Resumen de Estabilidad

```{r stability_summary_table, echo=FALSE}
if (!is.null(params$stability_summary) && is.data.frame(params$stability_summary) && nrow(params$stability_summary) > 0) {
  
  stab_df <- params$stability_summary
  
  # Proper column names for display
  colnames(stab_df) <- c("Contaminante", "Nivel", "Items", "Réplicas", "sigma_pt", "u(x_pt)", "Diferencia", "Criterio c", "Cumple", "Conclusión")
  
  kable(stab_df, digits = 4, caption = "Tabla B.2. Resumen de Evaluación de Estabilidad")
} else {
  cat("No hay datos de estabilidad disponibles.")
}
```

# Anexo C: Resultados por Participante

A continuación se presentan los resultados detallados para cada participante.

```{r participant_results_loop, echo=FALSE, results='asis', fig.height=4, fig.width=8}
if (!is.null(params$participant_data) && length(params$participant_data) > 0) {
  for (pid in names(params$participant_data)) {
    p_info <- params$participant_data[[pid]]
    
    cat("\n\n## Código:", pid, "\n\n")
    
    # Print Matrix Plot
    print(p_info$matrix_plot)
    cat("\n\n")
    cat("Figura. Matriz de desempeño para el participante", pid, "\n\n")
    
    # Print Summary Table
    cat("### Tabla de Resultados\n\n")
    
    # Format table for display
    disp_table <- p_info$summary_table
    colnames(disp_table) <- c("Contaminante", "Nivel", "Resultado", "Incertidumbre", "Valor Asignado", "Incertidumbre VA", "Score", "Evaluación")
    
    print(kable(disp_table, digits = 4, caption = paste("Resultados detallados - Participante", pid)))
    cat("\n\n")
    cat("\\newpage") # Page break after each participant
  }
} else {
  cat("No hay datos de participantes disponibles.")
}
```