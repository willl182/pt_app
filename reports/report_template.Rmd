---
title: "Informe Final del Ensayo de Aptitud (EA)"
subtitle: "Medición de Gases Contaminantes Criterio SO₂, CO, O₃, NO, NO₂"
author: "Laboratorio CALAIRE"
date: "`r Sys.Date()`"
output:
  word_document:
    toc: true
    toc_depth: 3
    reference_docx: null
params:
  hom_data: NA
  stab_data: NA
  summary_data: NA
  metric: "z"
  method: "3"
  pollutant: NULL     # NULL = all pollutants
  level: "level_1"
  n_lab: 7
  k_factor: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 5)
library(tidyverse)
library(knitr)
library(kableExtra)
library(outliers)

# Helper: nIQR
calculate_niqr <- function(x) {
  x_clean <- x[is.finite(x)]
  if (length(x_clean) < 2) return(NA_real_)
  quartiles <- stats::quantile(x_clean, probs = c(0.25, 0.75), na.rm = TRUE, type = 7)
  0.7413 * (quartiles[2] - quartiles[1])
}

# Helper: Prepare Wide Data
get_wide_data <- function(df, target_pollutant) {
  filtered <- df %>% filter(pollutant == target_pollutant)
  if (nrow(filtered) == 0) return(NULL)
  filtered %>%
    select(-pollutant) %>%
    pivot_wider(names_from = replicate, values_from = value, names_prefix = "sample_")
}

# Lógica: Algoritmo A (ISO 13528)
run_algorithm_a <- function(values, max_iter = 50) {
  values <- values[is.finite(values)]
  n <- length(values)
  if (n < 3) return(list(mean = NA, sd = NA, error = "N<3"))
  
  x_star <- median(values, na.rm = TRUE)
  s_star <- 1.483 * median(abs(values - x_star), na.rm = TRUE)
  
  for (i in 1:max_iter) {
    u_val <- (values - x_star) / (1.5 * s_star)
    w <- ifelse(abs(u_val) <= 1, 1, 1/u_val^2)
    
    x_new <- sum(w * values) / sum(w)
    s_new <- sqrt(sum(w * (values - x_new)^2) / sum(w))
    
    if (abs(x_new - x_star) < 1e-4 & abs(s_new - s_star) < 1e-4) break
    x_star <- x_new
    s_star <- s_new
  }
  list(mean = x_star, sd = s_star, error = NULL)
}

# Lógica: Cálculo de Homogeneidad
compute_homogeneity <- function(data_full, pol, lev) {
  wide <- get_wide_data(data_full, pol) %>% filter(level == lev)
  if(nrow(wide) == 0) return(NULL)
  
  cols_sample <- grep("sample_", names(wide), value = TRUE)
  m <- length(cols_sample)
  g <- nrow(wide)
  
  long_data <- wide %>%
    mutate(Item = row_number()) %>%
    pivot_longer(cols = all_of(cols_sample), values_to = "Result")
  
  item_stats <- long_data %>%
    group_by(Item) %>%
    summarise(mean = mean(Result), diff = max(Result) - min(Result))
  
  general_mean <- mean(item_stats$mean)
  s_x_bar_sq <- var(item_stats$mean)
  
  sw <- sqrt(sum(item_stats$diff^2) / (2 * g))
  ss <- sqrt(max(0, s_x_bar_sq - (sw^2 / m)))
  
  sample1 <- wide$sample_1
  sigma_pt <- 1.483 * median(abs(sample1 - median(sample1)))
  c_crit <- 0.3 * sigma_pt
  
  list(
    ss = ss, sw = sw, sigma_pt = sigma_pt, c_crit = c_crit, 
    mean = general_mean, passed = ss <= c_crit
  )
}

# Lógica: Cálculo de Estabilidad
compute_stability <- function(stab_full, pol, lev, hom_mean, hom_sigma) {
  wide <- get_wide_data(stab_full, pol) %>% filter(level == lev)
  if(nrow(wide) == 0) return(NULL)
  
  cols_sample <- grep("sample_", names(wide), value = TRUE)
  vals <- wide %>% select(all_of(cols_sample)) %>% unlist()
  stab_mean <- mean(vals, na.rm=TRUE)
  
  diff_stab <- abs(hom_mean - stab_mean)
  c_crit <- 0.3 * hom_sigma
  
  list(
    mean = stab_mean, diff = diff_stab, c_crit = c_crit, 
    passed = diff_stab <= c_crit
  )
}

# Determine which pollutants to process
pollutants_to_process <- if (is.null(params$pollutant)) {
  unique(params$summary_data$pollutant)
} else {
  params$pollutant
}
```

# Informe de Ensayo de Aptitud

**Fecha:** `r Sys.Date()`  
**Esquema (n):** `r params$n_lab`  
**Nivel:** `r params$level`  
**Métrica:** `r params$metric`  
**Método:** `r params$method`

```{r process_all_pollutants, results='asis'}
for (pol in pollutants_to_process) {
  cat("\n\n## Analito:", toupper(pol), "\n\n")
  
  # Selección de Datos Específicos
  target_pt_data <- params$summary_data %>%
    filter(pollutant == pol, 
           level == params$level, 
           n_lab == params$n_lab)
  
  if (nrow(target_pt_data) == 0) {
    cat("No hay datos disponibles para esta combinación.\n\n")
    next
  }
  
  ref_data <- target_pt_data %>% filter(participant_id == "ref")
  part_data <- target_pt_data %>% filter(participant_id != "ref")
  
  # Cálculo del Valor Asignado
  calc_assigned_value <- function(method, p_data, r_data) {
    if (method == "1") {
      return(list(xpt = mean(r_data$mean_value), u_xpt = mean(r_data$sd_value), source = "Referencia"))
    } else if (method == "2a") {
      vals <- p_data$mean_value
      med <- median(vals, na.rm = TRUE)
      made <- 1.483 * median(abs(vals - med), na.rm = TRUE)
      return(list(xpt = med, u_xpt = 1.25 * made / sqrt(length(vals)), sigma = made, source = "Consenso MADe"))
    } else if (method == "2b") {
      vals <- p_data$mean_value
      med <- median(vals, na.rm = TRUE)
      niqr <- calculate_niqr(vals)
      return(list(xpt = med, u_xpt = 1.25 * niqr / sqrt(length(vals)), sigma = niqr, source = "Consenso nIQR"))
    } else if (method == "3") {
      res <- run_algorithm_a(p_data$mean_value)
      return(list(xpt = res$mean, u_xpt = 1.25 * res$sd / sqrt(nrow(p_data)), sigma = res$sd, source = "Algoritmo A"))
    }
    return(list(xpt = NA, u_xpt = NA, source = "Desconocido"))
  }
  
  # Ejecutar Cálculos
  hom_res <- compute_homogeneity(params$hom_data, pol, params$level)
  assigned <- calc_assigned_value(params$method, part_data, ref_data)
  
  # Determinar Sigma pt final
  final_sigma <- if(!is.null(assigned$sigma)) assigned$sigma else hom_res$sigma_pt
  
  # Calcular Scores
  scores_df <- part_data %>%
    mutate(
      z_score = (mean_value - assigned$xpt) / final_sigma,
      z_prime = (mean_value - assigned$xpt) / sqrt(final_sigma^2 + assigned$u_xpt^2),
      zeta_score = (mean_value - assigned$xpt) / sqrt(sd_value^2 + assigned$u_xpt^2),
      En_score = (mean_value - assigned$xpt) / sqrt((params$k_factor * sd_value)^2 + (params$k_factor * assigned$u_xpt)^2)
    )
  
  metric_col <- switch(params$metric,
                       "z" = "z_score",
                       "z_prime" = "z_prime",
                       "z'" = "z_prime",
                       "zeta" = "zeta_score",
                       "En" = "En_score")
  
  scores_df <- scores_df %>%
    mutate(Score_Final = .data[[metric_col]]) %>%
    mutate(Evaluacion = case_when(
      params$metric == "En" & abs(Score_Final) <= 1 ~ "Satisfactorio",
      params$metric == "En" & abs(Score_Final) > 1 ~ "Insatisfactorio",
      params$metric != "En" & abs(Score_Final) <= 2 ~ "Satisfactorio",
      params$metric != "En" & abs(Score_Final) < 3 ~ "Cuestionable",
      TRUE ~ "Insatisfactorio"
    ))
  
  # Homogeneidad y Estabilidad
  cat("### 1. Evaluación de Homogeneidad y Estabilidad\n\n")
  
  if(!is.null(hom_res)) {
    hom_df <- data.frame(
      Parámetro = c("Desviación estándar entre muestras (ss)", "Criterio de aceptación (c)", "Conclusión"),
      Valor = c(sprintf("%.4f", hom_res$ss), sprintf("%.4f", hom_res$c_crit), 
                ifelse(hom_res$passed, "CUMPLE", "NO CUMPLE"))
    )
    print(kable(hom_df, caption = "Resultados de Homogeneidad"))
  }
  
  stab_res <- compute_stability(params$stab_data, pol, params$level, hom_res$mean, hom_res$sigma_pt)
  
  if(!is.null(stab_res)) {
    stab_df <- data.frame(
      Parámetro = c("Diferencia medias (Hom vs Stab)", "Criterio de estabilidad (0.3 * sigma)", "Conclusión"),
      Valor = c(sprintf("%.4f", stab_res$diff), sprintf("%.4f", stab_res$c_crit),
                ifelse(stab_res$passed, "CUMPLE", "NO CUMPLE"))
    )
    print(kable(stab_df, caption = "Resultados de Estabilidad"))
  }
  
  # Valor Asignado
  cat("\n\n### 2. Determinación del Valor Asignado\n\n")
  cat("El valor asignado ($x_{pt}$) se determinó utilizando el método:", assigned$source, "\n\n")
  cat("*   **Valor Asignado ($x_{pt}$):**", sprintf("%.4f", assigned$xpt), "\n")
  cat("*   **Incertidumbre ($u(x_{pt})$):**", sprintf("%.4f", assigned$u_xpt), "\n")
  cat("*   **Desviación estándar para evaluación ($\\sigma_{pt}$):**", sprintf("%.4f", final_sigma), "\n\n")
  
  # Resultados de Participantes
  cat("### 3. Resultados de los Participantes\n\n")
  
  table_view <- scores_df %>%
    select(Participante = participant_id, 
           Resultado = mean_value, 
           Incertidumbre = sd_value, 
           Score = Score_Final, 
           Evaluación = Evaluacion)
  
  print(kable(table_view, digits = 4, caption = paste("Resultados y Puntaje", params$metric)))
  
  # Gráfico de Desempeño
  cat("\n\n### 4. Gráfico de Desempeño\n\n")
  
  p <- ggplot(scores_df, aes(x = participant_id, y = Score_Final)) +
    geom_bar(stat = "identity", fill = ifelse(scores_df$Evaluacion == "Satisfactorio", "#2E7D32", "#C62828"), width = 0.6) +
    geom_hline(yintercept = 0, color = "black") +
    labs(title = paste("Desempeño de Participantes -", toupper(pol), "- Puntaje", params$metric),
         x = "Participante", y = paste("Puntaje", params$metric)) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  if(params$metric == "En") {
    p <- p + 
      geom_hline(yintercept = 1, linetype = "dashed", color = "red") +
      geom_hline(yintercept = -1, linetype = "dashed", color = "red")
  } else {
    p <- p + 
      geom_hline(yintercept = 2, linetype = "dashed", color = "orange") +
      geom_hline(yintercept = -2, linetype = "dashed", color = "orange") +
      geom_hline(yintercept = 3, linetype = "dashed", color = "red") +
      geom_hline(yintercept = -3, linetype = "dashed", color = "red")
  }
  
  print(p)
  
  # Conclusiones
  cat("\n\n### 5. Conclusiones\n\n")
  cat("*   **Número total de participantes:**", nrow(scores_df), "\n")
  cat("*   **Resultados Satisfactorios:**", sum(scores_df$Evaluacion == "Satisfactorio"), "\n")
  cat("*   **Resultados Insatisfactorios/Cuestionables:**", sum(scores_df$Evaluacion != "Satisfactorio"), "\n\n")
  
  cat("\n\n---\n\n")
}
```