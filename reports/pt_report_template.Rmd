---
title: "Informe de Resultados de Ensayo de Aptitud"
output:
  html_document:
    toc: true
    toc_depth: 2
params:
  pollutant: ""
  n_lab: ""
  level: ""
  sigma_pt_input: 0
  u_xpt_input: 0
  k_input: 0
  hom: NULL
  stab: NULL
  scores: NULL
  generated_at: !r Sys.time()
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(dplyr)
library(ggplot2)
library(knitr)
```

## Resumen General

- **Analito:** `r toupper(params$pollutant)`
- **Nivel:** `r params$level`
- **Esquema PT (n):** `r params$n_lab`
- **Parámetros usados para puntajes:** σ<sub>pt</sub> = `r params$sigma_pt_input`, u<sub>xpt</sub> = `r params$u_xpt_input`, k = `r params$k_input`
- **Fecha de generación:** `r format(params$generated_at, "%Y-%m-%d %H:%M:%S")`

## 1. Evaluación de Homogeneidad

```{r homogeneity-summary}
hom <- params$hom
if (!is.null(hom) && is.null(hom$error)) {
  cat("**Conclusión:**", gsub("<br>", " | ", hom$conclusion), "\n\n")
  
  hom_summary <- hom$summary
  hom_summary <- hom_summary %>%
    mutate(Fuente = rownames(hom$summary), .before = 1)
  kable(hom_summary, caption = "Tabla ANOVA (Método Manual)")
  
  indicadores <- data.frame(
    Indicador = c("ss", "sw", "c", "c (expandido)", "MADe (σ_pt)", "nIQR"),
    Valor = c(hom$ss, hom$sw, hom$c_criterion, hom$c_criterion_expanded, hom$sigma_pt, hom$n_iqr)
  )
  indicadores$Valor <- format(indicadores$Valor, digits = 6, scientific = FALSE)
  kable(indicadores, caption = "Indicadores clave de homogeneidad")
} else if (!is.null(hom) && !is.null(hom$error)) {
  cat("No se pudo calcular la homogeneidad:", hom$error)
} else {
  cat("No se proporcionaron resultados de homogeneidad.")
}
```

## 2. Evaluación de Estabilidad

```{r stability-summary}
stab <- params$stab
if (!is.null(stab) && is.null(stab$error)) {
  cat("**Conclusión:**", stab$stab_conclusion, "\n\n")
  cat(sprintf("|y1 - y2| = %.6f, c = %.6f, c (expandido) = %.6f\n\n",
              stab$diff_hom_stab, stab$stab_c_criterion, stab$stab_c_criterion_expanded))
  
  stab_summary <- stab$stab_summary %>%
    mutate(Fuente = rownames(stab$stab_summary), .before = 1)
  kable(stab_summary, caption = "Tabla ANOVA para estabilidad")
  
  stab_indicadores <- data.frame(
    Indicador = c("ss", "sw", "MADe (σ_pt)", "nIQR"),
    Valor = c(stab$stab_ss, stab$stab_sw, stab$stab_sigma_pt, stab$stab_n_iqr)
  )
  stab_indicadores$Valor <- format(stab_indicadores$Valor, digits = 6, scientific = FALSE)
  kable(stab_indicadores, caption = "Indicadores clave de estabilidad")
} else if (!is.null(stab) && !is.null(stab$error)) {
  cat("No se pudo calcular la estabilidad:", stab$error)
} else {
  cat("No se proporcionaron resultados de estabilidad.")
}
```

## 3. Puntajes de Desempeño

```{r scores-table}
scores <- params$scores
if (!is.null(scores) && is.null(scores$error)) {
  score_table <- scores$scores %>%
    select(
      Participante = participant_id,
      Resultado = result,
      `u(xi)` = uncertainty_std,
      `z` = z_score,
      `Eval z` = z_score_eval,
      `z'` = z_prime_score,
      `Eval z'` = z_prime_score_eval,
      `ζ` = zeta_score,
      `Eval ζ` = zeta_score_eval,
      `En` = En_score,
      `Eval En` = En_score_eval
    )
  score_table <- score_table %>%
    mutate(across(c(Resultado, `u(xi)`, `z`, `z'`, `ζ`, `En`), ~ format(.x, digits = 4, scientific = FALSE)))
  kable(score_table, caption = "Tabla de puntajes por participante")
} else if (!is.null(scores) && !is.null(scores$error)) {
  cat("No se pudieron calcular los puntajes:", scores$error)
} else {
  cat("No se proporcionaron resultados de puntajes.")
}
```

```{r scores-z-plot, fig.width=7, fig.height=4}
if (!is.null(scores) && is.null(scores$error) && nrow(scores$scores) > 0) {
  ggplot(scores$scores, aes(x = reorder(participant_id, z_score), y = z_score)) +
    geom_hline(yintercept = c(-3, -2, 2, 3), linetype = "dashed", color = c("red", "orange", "orange", "red")) +
    geom_hline(yintercept = 0, linetype = "solid", color = "grey40") +
    geom_point(size = 3, color = "#2E86C1") +
    labs(
      title = "Distribución de puntajes z",
      x = "Participante",
      y = "z-score"
    ) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}
```

## 4. Observaciones

- Los resultados se generan automáticamente a partir del aplicativo Shiny.
- Verifique que los archivos de entrada correspondan al lote evaluado.
- Para reproducir este informe utilice la misma versión del aplicativo y de los datos fuente.
