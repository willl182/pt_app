%% Diagrama de Flujo - Sistema PT App
%% Entregable 07: Dashboards y Visualizaci√≥n
%% Basado en arquitectura ISO 13528:2022 / ISO 17043:2024

%% ============================================
%% DIAGRAMA 1: Flujo Principal de Datos
%% ============================================

flowchart LR
    subgraph Datos_Entrada["üìÅ Archivos de Entrada"]
        A[homogeneity.csv]
        B[stability.csv]
        C[summary_n*.csv]
        D[participants_data*.csv]
    end
    
    subgraph Carga["üì• Carga de Datos"]
        E[hom_data_full]
        F[stab_data_full]
        G[pt_prep_data]
    end
    
    subgraph Procesamiento["‚öôÔ∏è Procesamiento"]
        H[Homogeneidad]
        I[Estabilidad]
        J[Valor Asignado]
        K[Puntajes PT]
    end
    
    subgraph Visualizacion["üìä Visualizaci√≥n"]
        L[Tablas DT]
        M[Histogramas]
        N[Boxplots]
        O[Heatmaps]
    end
    
    A --> E --> H
    B --> F --> I
    C --> G --> J & K
    H & I & J & K --> L & M & N & O

%% ============================================
%% DIAGRAMA 2: Grafo de Dependencias Reactivas
%% ============================================

graph TD
    subgraph Client_Layer["üñ•Ô∏è Capa Cliente (UI)"]
        UI["Interfaz de Usuario"]
        INPUTS["Selectores de Entrada<br/>fileInput, selectInput, sliderInput"]
        OUTPUTS["Salidas<br/>Tablas, Gr√°ficos, Reportes"]
    end
    
    subgraph Reactive_Layer["‚ö° Capa Reactiva (Server)"]
        DL["Reactivos de Carga<br/>hom_data_full(), stab_data_full()"]
        VR["Valores Reactivos<br/>rv$raw_summary_data"]
        AL["Reactivos de An√°lisis<br/>homogeneity_run(), stability_run()"]
        TR["Triggers<br/>analysis_trigger, scores_trigger"]
        CACHE["Cache de Resultados<br/>algoA_cache, scores_cache"]
    end
    
    subgraph Calculation_Layer["üìê Capa de C√°lculo (ptcalc)"]
        ROBUST["Estad√≠sticos Robustos<br/>run_algorithm_a(), calculate_niqr()"]
        HOM["Homogeneidad<br/>calculate_homogeneity_stats()"]
        STAB["Estabilidad<br/>calculate_stability_stats()"]
        SCORES["Puntajes<br/>calculate_z_score(), calculate_en_score()"]
    end
    
    subgraph Visualization_Layer["üìä Capa de Visualizaci√≥n"]
        PLOTS["Gr√°ficos Plotly<br/>scatter, histogramas, boxplots"]
        TABLES["DataTables<br/>tablas de resultados"]
        REPORTS["Reportes RMarkdown<br/>HTML/Word"]
    end

    INPUTS --> DL
    DL --> VR
    VR --> AL
    AL --> ROBUST & HOM & STAB
    TR --> CACHE
    CACHE --> SCORES
    ROBUST --> SCORES
    SCORES --> PLOTS & TABLES & REPORTS
    PLOTS & TABLES & REPORTS --> OUTPUTS
    UI -.-> INPUTS
    OUTPUTS -.-> UI

%% ============================================
%% DIAGRAMA 3: Cadena de C√°lculo de Puntajes
%% ============================================

flowchart TD
    BTN["input$scores_run<br/>Clic de bot√≥n"] --> OE["observeEvent"]
    
    OE --> LOOP{"Para cada<br/>pollutant/level/n_lab"}
    
    LOOP --> CSF["compute_scores_for_selection"]
    
    CSF --> CHM["compute_homogeneity_metrics"]
    CSF --> CSM["compute_stability_metrics"]
    CSF --> RAA["run_algorithm_a"]
    
    CHM --> |"sigma_pt, u_xpt"| CCS["compute_combo_scores"]
    CSM --> |"u_stab"| CCS
    RAA --> |"assigned_value, robust_sd"| CCS
    
    CCS --> |"por cada m√©todo"| CACHE["scores_results_cache"]
    
    CACHE --> TRIG["scores_trigger"]
    TRIG --> SRS["scores_results_selected"]
    SRS --> OUT["Tablas y gr√°ficos de salida"]

%% ============================================
%% DIAGRAMA 4: Flujo de Datos Primario
%% ============================================

flowchart TD
    subgraph File_Inputs["Archivos de Entrada"]
        HF["input$hom_file"]
        SF["input$stab_file"]
        SUM["input$summary_files"]
    end

    subgraph Raw_Data["Datos Crudos Reactivos"]
        HDF["hom_data_full"]
        SDF["stab_data_full"]
        PPD["pt_prep_data"]
    end

    subgraph Processed["Datos Procesados"]
        RD["raw_data"]
        SDR["stability_data_raw"]
        RV["rv$raw_summary_data"]
    end

    subgraph Results["Resultados de An√°lisis"]
        HR["homogeneity_run"]
        SR["stability_run"]
    end

    HF --> HDF --> RD --> HR
    SF --> SDF --> SDR --> SR
    SUM --> PPD --> RV --> SR

%% ============================================
%% DIAGRAMA 5: Patr√≥n Trigger-Cache
%% ============================================

graph LR
    A["Usuario hace clic"] --> B["observeEvent activa trigger"]
    B --> C["Cambia timestamp del trigger"]
    C --> D["Reactivo se invalida"]
    D --> E["Se ejecuta c√°lculo"]
    E --> F["Resultados se almacenan en cache"]
    F --> G["Output se actualiza"]

%% ============================================
%% DIAGRAMA 6: Invalidaci√≥n de Cache
%% ============================================

flowchart TD
    SUM["input$summary_files cambia"] --> OE["observeEvent"]
    OE --> CL["Limpiar todos los caches:<br/>algoA, consensus, scores"]
    OE --> RT["Resetear triggers a NULL"]

%% ============================================
%% DIAGRAMA 7: Flujo de Secuencia de Datos
%% ============================================

sequenceDiagram
    participant U as Usuario
    participant UI as UI
    participant S as Server Reactives
    participant P as ptcalc Package
    participant C as Cache
    
    U->>UI: Cargar archivos CSV
    UI->>S: input$files
    S->>S: Validar columnas y almacenar en rv
    U->>UI: Clic "Calcular Puntajes"
    UI->>S: scores_run
    S->>C: Verificar clave de cache
    alt Cache Miss
        S->>P: Llamar ptcalc::compute_scores
        P-->>S: Retornar puntajes
        S->>C: Actualizar cache
    end
    S->>UI: Actualizar heatmaps y tablas

%% ============================================
%% DIAGRAMA 8: Estructura del Servidor
%% ============================================

flowchart TB
    subgraph Server["Estructura del Servidor"]
        DL["Data Loading<br/>l√≠neas 80-160"]
        TC["Trigger/Cache Setup<br/>l√≠neas 161-224"]
        HF["Helper Functions<br/>l√≠neas 226-638"]
        AA["Algorithm A Handler<br/>l√≠neas 642-715"]
        UI_DYN["Dynamic UI Layout<br/>l√≠neas 717-1165"]
        HS["Homogeneity/Stability<br/>l√≠neas 1168-1390"]
        UT["Uncertainty Tables<br/>l√≠neas 1291-1389"]
        DP["Data Preview<br/>l√≠neas 1391-1718"]
        PS["PT Scores Module<br/>l√≠neas 1720-2255"]
        GR["Global Report<br/>l√≠neas 2256-3237"]
        PM["Participants Module<br/>l√≠neas 3238-3746"]
        RG["Report Generation<br/>l√≠neas 3748-4690"]
        AV["Assigned Value<br/>l√≠neas 4715-5042"]
        OM["Outliers Module<br/>l√≠neas 5114-5176"]
    end

    DL --> TC --> HF --> AA
    AA --> UI_DYN --> HS --> UT
    UT --> DP --> PS --> GR
    GR --> PM --> RG --> AV --> OM

%% ============================================
%% DIAGRAMA 9: Selecci√≥n de Puntajes
%% ============================================

flowchart TD
    A["Seleccionar Tipo de Puntaje"] --> B{"¬øParticipante<br/>reporta incertidumbre?"}
    B -->|No| C{"¬øu_xpt significativo<br/>respecto a sigma_pt?"}
    C -->|No| D["Usar z-score"]
    C -->|S√≠| E["Usar z'-score"]
    B -->|S√≠| F{"¬øEvaluar incertidumbre<br/>reportada?"}
    F -->|No| G["Usar z o z'"]
    F -->|S√≠| H{"¬øU expandida<br/>disponible?"}
    H -->|No| I["Usar zeta-score"]
    H -->|S√≠| J["Usar En-score"]
